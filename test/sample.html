<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Layer Authentication</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.27/"></script>
</head>

<body>
  <!-- Dropdown for Feature Layers -->
  <div style="position: absolute; top: 10px; left: 10px; z-index: 99; background: white; padding: 10px; border-radius: 5px;">
    <label for="featureLayerDropdown">Select Feature Layer:</label>
    <select id="featureLayerDropdown">
      <option value="">-- Select a Feature Layer --</option>
      <option value="https://services8.arcgis.com/h9TUF6x5VzqLQaYx/arcgis/rest/services/Test_Dataset_Clone_to_Portal/FeatureServer">
        Test Dataset Clone
      </option>
      <option value="https://services8.arcgis.com/h9TUF6x5VzqLQaYx/arcgis/rest/services/SC_PROW/FeatureServer">
        SC PROW
      </option>
    </select>
  </div>

  <!-- Map View -->
  <div id="viewDiv" style="height: 100vh;"></div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/identity/OAuthInfo",
      "esri/identity/IdentityManager"
    ], function (Map, MapView, FeatureLayer, OAuthInfo, IdentityManager) {

      // OAuth configuration
      const oauthInfo = new OAuthInfo({
        appId: "93ypiaCdiAJx888j", // Replace with your app's Client ID
        portalUrl: "https://www.arcgis.com",
        popupCallbackUrl: "https://slmaravilla.github.io/test/sample.html",
        popup: true // Use popup for authentication
      });

      IdentityManager.registerOAuthInfos([oauthInfo]);

      // Automatically sign in the user
      IdentityManager.checkSignInStatus(oauthInfo.portalUrl)
        .then(() => {
          console.log("User is signed in!");
        })
        .catch(() => {
          // If not signed in, initiate OAuth sign-in
          IdentityManager.getCredential(oauthInfo.portalUrl);
        });

      // Create a map
      const map = new Map({
        basemap: "topo-vector"
      });

      // Create a MapView
      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [120.9842, 14.5995], // Example: Manila coordinates
        zoom: 12
      });

      // Dropdown change event listener
      const featureLayerDropdown = document.getElementById("featureLayerDropdown");
      let activeFeatureLayer;

      featureLayerDropdown.addEventListener("change", function () {
        const selectedUrl = featureLayerDropdown.value;

        // Remove the currently active layer if any
        if (activeFeatureLayer) {
          map.remove(activeFeatureLayer);
        }

        // If a valid URL is selected, add the new feature layer
        if (selectedUrl) {
          activeFeatureLayer = new FeatureLayer({
            url: selectedUrl,
            outFields: ["*"],
          });

          map.add(activeFeatureLayer);

          console.log("Feature layer added:", selectedUrl);
        }
      });
    });
  </script>

</body>

</html>
